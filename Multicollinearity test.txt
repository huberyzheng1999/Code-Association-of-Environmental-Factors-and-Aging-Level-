import pandas as pd
import numpy as np
import statsmodels.api as sm
from statsmodels.stats.outliers_influence import variance_inflation_factor
import warnings
warnings.filterwarnings('ignore')


def load_panel_data(file_path):
    df = pd.read_excel(file_path)
    panel_id = 'pac'          
    time_col = 'Year'        
    group_col = 'Urb'         
    
    independent_vars = [
        'GDP', ……
    ]

    df[panel_id] = df[panel_id].astype(str)
    df[time_col] = df[time_col].astype(int)
    drop_na_cols = independent_vars + [panel_id, time_col, group_col]
    df_clean = df.dropna(subset=drop_na_cols)
    df_clean['Urb_Group'] = pd.cut(
        df_clean[group_col],
        bins=[-1, 3, 7, 10],
        labels=['低城市化组', '中城市化组', '高城市化组']
    )
    df_panel = df_clean.set_index([panel_id, time_col])
    return df_panel, independent_vars

def get_within_residuals(group_data, independent_vars):
    county_means = group_data[independent_vars].groupby(level=0).transform('mean')
    within_residuals = group_data[independent_vars] - county_means
    within_residuals = within_residuals.dropna()
    return within_residuals

def calculate_stratified_vif(df_panel, independent_vars):
    vif_results_all = {}
    urban_groups = ['低城市化组', '中城市化组', '高城市化组']

    for group_name in urban_groups:
        group_data = df_panel[df_panel['Urb_Group'] == group_name].copy()
        if len(group_data) < 10:  
            print(f"  警告：{group_name}样本量不足（{len(group_data)}观测），跳过")
            continue

        within_res = get_within_residuals(group_data, independent_vars)
        if len(within_res) < len(independent_vars) + 1:  
            print(f"  警告：{group_name}组内残差样本量不足，跳过")
            continue

        X = sm.add_constant(within_res) 
        X = X.loc[:, ~X.columns.duplicated()]

        vif_list = []
        for i, var in enumerate(independent_vars):
            if var not in X.columns:
                vif_list.append([group_name, var, '变量缺失', '否'])
                continue
            try:
                vif = variance_inflation_factor(X.values, i+1)  
                vif = round(vif, 3) if np.isfinite(vif) else 100.0  
            except:
                vif = '计算失败'
                vif_list.append([group_name, var, vif, '否'])
                continue

            need_remove = '是' if (isinstance(vif, float) and vif > 10) else '否'
            vif_list.append([group_name, var, vif, need_remove])

        vif_df = pd.DataFrame(
            vif_list,
            columns=['城市化分组', '自变量名', 'VIF值', '需剔除（VIF>10）']
        ).sort_values('VIF值', ascending=False, na_position='last')

        vif_results_all[group_name] = vif_df
        print(f"  完成：{group_name}（需剔除{sum(vif_df['需剔除（VIF>10）']=='是')}个变量）")

    return vif_results_all

def save_vif_to_excel(vif_results_all, save_path):
    with pd.ExcelWriter(save_path, engine='openpyxl') as writer:
        for group_name, vif_df in vif_results_all.items():
            vif_df.to_excel(writer, sheet_name=f'{group_name}VIF结果', index=False)
        if vif_results_all:
            vif_all = pd.concat(vif_results_all.values(), ignore_index=True)
            vif_all.to_excel(writer, sheet_name='所有分组VIF汇总', index=False)

    print(f"\n=== VIF结果已保存至：{save_path} ===")
    print("Excel包含：")
    for sheet in [f'{g}VIF结果' for g in vif_results_all.keys()] + ['所有分组VIF汇总']:
        print(f"  - {sheet}")

def main(file_path, save_path):
    df_panel, independent_vars = load_panel_data(file_path)
    print(f"数据预处理完成：{len(df_panel)}观测，{len(independent_vars)}自变量")
    vif_results = calculate_stratified_vif(df_panel, independent_vars)
    if vif_results:
        save_vif_to_excel(vif_results, save_path)
    else:
        print("=== 无有效VIF结果生成 ===")

if __name__ == '__main__':
    DATA_FILE = 'C:/……'
    VIF_SAVE_PATH = 'C:/……'

    main(file_path=DATA_FILE, save_path=VIF_SAVE_PATH)
