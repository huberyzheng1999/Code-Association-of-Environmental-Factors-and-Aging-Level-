import pandas as pd
import numpy as np
import statsmodels.api as sm
from statsmodels.stats.outliers_influence import variance_inflation_factor
from statsmodels.regression.linear_model import OLS
import warnings

warnings.filterwarnings('ignore')
DATA_FILE_PATH = 'C:/……'  
RESULT_SAVE_PATH = 'C:/……'  

PANEL_ID = 'pac'  
TIME_COL = 'Year'  
GROUP_COL = 'Urb'  
TARGET_VARS = ['LA65', 'LA85']  
URBAN_GROUPS = ['低城市化组', '中城市化组', '高城市化组']  

INDEPENDENT_VARS = {
   'PM25', ……
}

ALL_INDEP_VARS = []
for var_list in INDEPENDENT_VARS.values():
    ALL_INDEP_VARS.extend(var_list)
ALL_INDEP_VARS = list(set(ALL_INDEP_VARS))

SELECTION_CRITERIA = 'both'  
F_ENTER = 0.05  
F_REMOVE = 0.10  

VIF_THRESHOLD = 10  
P_THRESHOLD = 0.05 

def load_and_prepare_data(file_path):
   
    df = pd.read_excel(file_path)
    df[PANEL_ID] = df[PANEL_ID].astype(str)
    df[TIME_COL] = df[TIME_COL].astype(int)

    df['Urb_Group'] = pd.cut(
        df[GROUP_COL],
        bins=[-1, 3, 7, 10],
        labels=URBAN_GROUPS
    )

    df_panel = df.set_index([PANEL_ID, TIME_COL])
    residual_data = df_panel.copy()
    county_means = residual_data[ALL_INDEP_VARS + TARGET_VARS].groupby(level=0).transform('mean')
    residual_data[ALL_INDEP_VARS + TARGET_VARS] = residual_data[ALL_INDEP_VARS + TARGET_VARS] - county_means

    drop_na_cols = ALL_INDEP_VARS + TARGET_VARS + ['Urb_Group']
    df_panel = df_panel.dropna(subset=drop_na_cols)
    residual_data = residual_data.dropna(subset=drop_na_cols)

    return df_panel, residual_data

def stepwise_regression(X, y, criteria='both', f_enter=0.05, f_remove=0.10):
    included = []
    excluded = list(X.columns)

    if criteria in ['forward', 'both']:
        while True:
            p_values = []
            for var in excluded:
                temp_included = included + [var]
                if len(temp_included) == 0:
                    continue
                X_temp = sm.add_constant(X[temp_included])
                model = OLS(y, X_temp).fit()
                p_values.append((var, model.pvalues[var]))

            if not p_values:
                break

            best_var, best_p = min(p_values, key=lambda x: x[1])
            if best_p < f_enter:
                included.append(best_var)
                excluded.remove(best_var)
            else:
                break

    if criteria in ['backward', 'both']:
        while True:
            if len(included) == 0:
                break
            X_temp = sm.add_constant(X[included])
            model = OLS(y, X_temp).fit()

            p_values = [(var, model.pvalues[var]) for var in included]
            worst_var, worst_p = max(p_values, key=lambda x: x[1])

            if worst_p > f_remove:
                included.remove(worst_var)
                excluded.append(worst_var)
            else:
                break

    if len(included) == 0:
        return [], None
    X_final = sm.add_constant(X[included])
    final_model = OLS(y, X_final).fit()

    return included, final_model

def validate_model(X_selected, model):

    X_vif = sm.add_constant(X_selected)
    var_vif_dict = {}  
    for i, var in enumerate(X_selected.columns):
        vif = variance_inflation_factor(X_vif.values, i + 1)  
        var_vif_dict[var] = round(vif, 3)

    var_p_dict = {}  
    for var in X_selected.columns:
        var_p_dict[var] = round(model.pvalues[var], 4)

    vif_list = list(var_vif_dict.values())
    avg_vif = round(np.mean(vif_list), 3) if vif_list else np.nan
    max_vif = round(np.max(vif_list), 3) if vif_list else np.nan
    max_vif_var = max(var_vif_dict, key=var_vif_dict.get) if vif_list else ''

    p_list = list(var_p_dict.values())
    p_min = round(np.min(p_list), 4) if p_list else np.nan
    p_max = round(np.max(p_list), 4) if p_list else np.nan

    adj_r2 = round(model.rsquared_adj, 4)
    aic = round(model.aic, 4)

    summary_result = {
        '平均VIF': avg_vif,
        '最大VIF': max_vif,
        '最大VIF变量': max_vif_var,
        'P值最小值': p_min,
        'P值最大值': p_max,
        '调整后R²': adj_r2,
        'AIC值': aic
    }

    detail_result = []  
    for var in X_selected.columns:
        var_type = '其他'
        for type_name, var_list in INDEPENDENT_VARS.items():
            if var in var_list:
                var_type = type_name
                break
        vif_pass = '是' if var_vif_dict[var] < VIF_THRESHOLD else '否'
        p_pass = '是' if var_p_dict[var] < P_THRESHOLD else '否'
        all_pass = '是' if (vif_pass == '是' and p_pass == '是') else '否'

        detail_result.append({
            '变量名': var,
            '变量类别': var_type,
            'VIF值': var_vif_dict[var],
            'P值': var_p_dict[var],
            'VIF达标（<10）': vif_pass,
            'P值达标（<0.05）': p_pass,
            '整体达标': all_pass
        })

    return summary_result, detail_result

def run_stratified_stepwise_regression():
    df_panel, residual_data = load_and_prepare_data(DATA_FILE_PATH)

    total_summary_list = []
    total_detail_list = []

    for urban_group in URBAN_GROUPS:
        for target in TARGET_VARS:
            print(f"\n--- 处理：{urban_group} - {target} ---")
            group_data = residual_data[residual_data['Urb_Group'] == urban_group].copy()
            if len(group_data) < len(ALL_INDEP_VARS) + 5:  
                print(f"  样本量不足（{len(group_data)}），跳过")
                continue

            X = group_data[ALL_INDEP_VARS].copy()
            y = group_data[target].copy()

            selected_vars, final_model = stepwise_regression(X, y, SELECTION_CRITERIA, F_ENTER, F_REMOVE)
            if len(selected_vars) == 0:
                print(f"  无显著变量，跳过")
                continue

            X_selected = X[selected_vars]
            summary_result, detail_result = validate_model(X_selected, final_model)

            summary_dict = {
                '城市化分组': urban_group,
                '因变量': target,
                '核心变量组合': ','.join(selected_vars),
                '平均VIF': summary_result['平均VIF'],
                '最大VIF': summary_result['最大VIF'],
                '最大VIF变量': summary_result['最大VIF变量'],
                'P值最小值': summary_result['P值最小值'],
                'P值最大值': summary_result['P值最大值'],
                '调整后R²': summary_result['调整后R²'],
                'AIC值': summary_result['AIC值'],
                '筛选准则': f"{SELECTION_CRITERIA}(F_enter={F_ENTER}, F_remove={F_REMOVE})"
            }
            total_summary_list.append(summary_dict)

            for var_detail in detail_result:
                var_detail['城市化分组'] = urban_group
                var_detail['因变量'] = target
                var_detail = {
                    '城市化分组': var_detail['城市化分组'],
                    '因变量': var_detail['因变量'],
                    '变量名': var_detail['变量名'],
                    '变量类别': var_detail['变量类别'],
                    'VIF值': var_detail['VIF值'],
                    'P值': var_detail['P值'],
                    'VIF达标（<10）': var_detail['VIF达标（<10）'],
                    'P值达标（<0.05）': var_detail['P值达标（<0.05）'],
                    '整体达标': var_detail['整体达标']
                }
                total_detail_list.append(var_detail)

            print(f"  核心变量：{','.join(selected_vars)}")
            print(f"  验证指标：调整R²={summary_result['调整后R²']}，平均VIF={summary_result['平均VIF']}")

    summary_df = pd.DataFrame(total_summary_list)
    detail_df = pd.DataFrame(total_detail_list)

    with pd.ExcelWriter(RESULT_SAVE_PATH, engine='openpyxl') as writer:
        summary_df.to_excel(writer, sheet_name='1-整体汇总结果', index=False)
        detail_df.to_excel(writer, sheet_name='2-变量明细（VIF+P值）', index=False)

    print(f"\n=== 所有分析完成！结果已保存至：{RESULT_SAVE_PATH} ===")
    print(f"\n=== 输出说明 ===")
    print("  1. 1-整体汇总结果：各分组的核心变量组合+汇总VIF/P值/R²")
    print("  2. 2-变量明细（VIF+P值）：每个筛选后变量的单独VIF、P值、是否达标")

    return summary_df, detail_df

if __name__ == '__main__':
    final_summary, final_detail = run_stratified_stepwise_regression()
    print("\n=== 变量明细预览（前10行）===")
    print(final_detail[['城市化分组', '因变量', '变量名', 'VIF值', 'P值', '整体达标']].head(10))
